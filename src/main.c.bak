/*==============================================================================
 * VEX DEFENDER - Main Entry Point
 * Phase 20: Polish & Final (save system, enhanced menus, play time)
 *============================================================================*/

#include "game.h"
#include "assets.h"
#include "engine/system.h"
#include "engine/vblank.h"
#include "engine/fade.h"
#include "engine/background.h"
#include "engine/sprites.h"
#include "engine/input.h"
#include "engine/scroll.h"
#include "engine/bullets.h"
#include "engine/collision.h"
#include "game/player.h"
#include "game/enemies.h"
#include "game/battle.h"
#include "game/rpg_stats.h"
#include "game/inventory.h"
#include "game/game_state.h"
#include "game/boss.h"
#include "game/dialog.h"
#include "engine/sound.h"

void bootSequence(void)
{
    /* Initialize all hardware */
    systemInit();

    /* Turn on screen at brightness 0 (still black) */
    setScreenOn();

    /* Wait 30 frames (0.5s) for hardware settle */
    systemWaitFrames(30);
}

int main(void)
{
    u16 pad_held, pad_pressed;

    bootSequence();

    /* Initialize sound system (SPC700 boot + BRR sample loading) */
    soundInit();

    /* Initialize input (needed before title screen) */
    inputInit();

    /* Initialize game state and show title screen */
    gsInit();
    gsTitleEnter();

    /* Main game loop */
    while (1) {
        WaitForVBlank();

        /* VBlank-sensitive updates (safe no-ops when not in flight) */
        bgVBlankUpdate();
        scrollVBlankUpdate();

        /* Read controller input */
        inputUpdate();
        pad_held = inputHeld();
        pad_pressed = inputPressed();

        /* State machine dispatch */
        switch (g_game.current_state) {

            case STATE_TITLE:
                gsTitleUpdate(pad_pressed);
                break;

            case STATE_FLIGHT:
                /* Pause toggle (Start button) */
                if (pad_pressed & ACTION_PAUSE) {
                    gsPauseToggle();
                    break;
                }

                /* Skip all updates while paused */
                if (g_game.paused) break;

                /* Flight gameplay */
                bgUpdate();
                scrollUpdate();
                playerHandleInput(pad_held);
                playerUpdate();

                /* Bullet firing (Y = ACTION_FIRE, auto-fire while held) */
                if (pad_held & ACTION_FIRE) {
                    bulletPlayerFire(g_player.x, g_player.y);
                }

                /* Weapon cycling (L/R shoulders, edge-triggered) */
                if (pad_pressed & ACTION_NEXT_WPN) bulletNextWeapon();
                if (pad_pressed & ACTION_PREV_WPN) bulletPrevWeapon();

                /* Update bullet positions and despawn off-screen */
                bulletUpdateAll();

                /* Update enemy AI, movement, firing, and despawn */
                enemyUpdateAll();

                /* Check all collisions (may set g_battle_trigger) */
                collisionCheckAll();

                /* Check for zone advancement (priority over dialog/battle) */
                if (g_zone_advance) {
                    gsZoneAdvance();
                    break;
                }

                /* Check for dialog trigger (priority over battle) */
                if (g_dialog_pending != 0) {
                    g_game.current_state = STATE_DIALOG;
                    dlgOpen(g_dialog_pending);
                    g_dialog_pending = 0;
                }
                /* Check for battle trigger */
                else if (g_battle_trigger != BATTLE_TRIGGER_NONE) {
                    g_game.current_state = STATE_BATTLE;
                    battleStart(g_battle_trigger);
                    g_battle_trigger = BATTLE_TRIGGER_NONE;
                } else {
                    /* Update sprite animations and write all active sprites to OAM */
                    spriteUpdateAll();
                    spriteRenderAll();

                    /* Render bullets and enemies AFTER spriteRenderAll */
                    bulletRenderAll();
                    enemyRenderAll();
                }
                break;

            case STATE_DIALOG:
                dlgUpdate(pad_pressed);
                if (!dlgIsActive()) {
                    /* Dialog finished, return to flight */
                    g_game.current_state = STATE_FLIGHT;
                }
                break;

            case STATE_BATTLE:
                battleUpdate(pad_pressed);
                if (battle.state == BSTATE_NONE) {
                    /* Battle ended */
                    if (battle.player.hp <= 0) {
                        /* Defeat: screen is dark, transition to game over */
                        gsGameOverEnter();
                    } else if (battle.is_boss) {
                        /* Phase 19: Boss defeated - advance zone directly.
                         * Screen is already dark from boss exit path. */
                        gsZoneAdvance();
                    } else {
                        /* Victory: battleTransitionOut already restored flight */
                        g_game.current_state = STATE_FLIGHT;
                    }
                }
                break;

            case STATE_GAMEOVER:
                gsGameOverUpdate(pad_pressed);
                break;

            case STATE_VICTORY:
                gsVictoryUpdate(pad_pressed);
                break;
        }

        /* Phase 20: Track play time (60 frames = 1 second at 60fps) */
        if (g_game.current_state == STATE_FLIGHT ||
            g_game.current_state == STATE_BATTLE ||
            g_game.current_state == STATE_DIALOG) {
            g_game.frame_counter++;
            if (g_game.frame_counter >= 60) {
                g_game.frame_counter = 0;
                if (g_game.play_time_seconds < 0xFFFF) {
                    g_game.play_time_seconds++;
                }
            }
        }

        /* Keep SPC700 driver alive (MUST call every frame) */
        soundUpdate();

        vblankProcessCallbacks();
    }

    return 0;
}
